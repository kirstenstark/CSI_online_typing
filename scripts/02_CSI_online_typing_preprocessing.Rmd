---
title: "02_CSI_online_typing_preprocessing"
author: "Kirsten Stark"
date: "2/26/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load packages
```{r}
library(dplyr)
library(tidyr)
```


## Load and preprocess data

```{r}
options( "encoding" = "UTF-8" )
pretest <- read.csv(here::here("data", "pretest_complete.csv"), 
    sep = ";",  na = "")
#pretest <- read_delim(here::here("data", "pretest_complete.csv"), 
#    ";", escape_double = FALSE, na = "", 
#    trim_ws = TRUE)

# exclude rows of unfinished experiments
pretest <- pretest %>% filter(FINISHED == "1")
```

Check attention checks: 
```{r}
## Item vs. non-item
# CH01_01 (Taube), CH01_02 (Apfel), CH02_01 (Luftballon) and CH02_02 (Biene) are items and 2 should be selected, 
# CH02_03 (Radio), CH02_04 (Sparschwein), CH02_03 (Laptop) and CH02_04 (Wattest√§bchen) are non-items and 1 should be selected
## Did participants cheat
# CH03 = 1 - yes, I worked through it till the end, 
# CH03 = 2 - no, I stopped or cheated midway
# CH03 = -9 - no answer
pretest <- pretest %>% mutate(attcheck = 
                  ifelse(CH01_01 == 2 & CH01_02 == 2 & CH02_01 == 2 & CH02_02 == 2 &
                  CH01_03 == 1 & CH01_04 == 1 & CH02_03 == 1 & CH02_04 == 1, 1, 0)) %>%
                   mutate(cheat = ifelse(CH03 == 1,1,ifelse(CH03 == 2,2,0)))
table(pretest$attcheck)
table(pretest$cheat)

# get prolific IDs of participants who failed the attention check
#pretest %>% subset(attcheck == 0 & cheat == 2 ) %>% 
#  pull(SD24_01) # SD24_01 is prolific ID

# subset to participants who passed only 
valid <- pretest %>% filter(attcheck == 1 & cheat != 2)

# add subject id
valid <- valid %>% mutate(subject = row_number())

```

## Convert to long format
First convert all variables that have values for each trial
```{r}
### MAIN LETTERS
# letters of first 1-80 trials of the main experiment
df1 <- valid %>%  select('subject', starts_with(c("XT"))) %>% 
                  pivot_longer(
                    cols = -subject,
                     names_to = c("trial", ".value"), 
                    names_pattern = "([^_]+)_(.*)",
                    values_to = "timing") %>%
                    group_by(subject) %>%
                    mutate(trial = seq(1,80, by = 1)) %>%
                   setNames(paste0('letters.', names(.))) 
# letters of last 81-160 trials of the main experiment
df2 <- valid %>%  select('subject', starts_with(c("XU"))) %>% 
                  pivot_longer(
                    cols = -subject,
                     names_to = c("trial", ".value"), 
                    names_pattern = "([^_]+)_(.*)",
                    values_to = "timing") %>%
                    group_by(subject) %>%
                    mutate(trial = seq(81,160, by = 1)) %>%
                   setNames(paste0('letters.', names(.)))
# bind first 80 and last 80 trials together
df_letters <- bind_rows(df1, df2) %>%
        rename(subject = letters.subject,
               trial = letters.trial) %>%
        arrange(subject, trial)
# delete letter columns from wide data frame
valid_red <- valid %>% select(!starts_with(c("XT", "XU")))

#### MAIN LETTER TIMING
# letter timing of first 1-80 trials of the main experiment
df1 <- valid %>% 
          select('subject', starts_with("TI") & !starts_with("TIME")) %>% 
                  pivot_longer(
                    cols = -subject,
                     names_to = c("trial", ".value"), 
                    names_pattern = "([^_]+)_(.*)",
                    values_to = "timing") %>%
                    group_by(subject) %>%
                    mutate(trial = seq(1,80, by = 1)) %>%
                   setNames(paste0('timing.', names(.))) 
# letter timing of last 81-160 trials of the main experiment
df2 <- valid %>%  select('subject', starts_with(c("TJ"))) %>% 
                  pivot_longer(
                    cols = -subject,
                     names_to = c("trial", ".value"), 
                    names_pattern = "([^_]+)_(.*)",
                    values_to = "timing") %>%
                    group_by(subject) %>%
                    mutate(trial = seq(81,160, by = 1)) %>%
                   setNames(paste0('timing.', names(.)))
# bind first 80 and last 80 trials together
df_timing <- bind_rows(df1, df2) %>%
        rename(subject = timing.subject,
               trial = timing.trial) %>%
        arrange(subject, trial)
# delete timing columns from wide data frame
valid_red <- valid_red %>% 
  select(!(starts_with(c("TI", "TJ")) & !starts_with("TIME")))
                
### MAIN WORDS
# typed words of first 1-80 trials of the main experiment
df1 <- valid %>% 
          select('subject', starts_with("AW")) %>% 
                  pivot_longer(
                    cols = -subject,
                     names_to = c("trial"), 
                    values_to = "word") %>%
                    group_by(subject) %>%
                    mutate(trial = seq(1,80, by = 1)) 
# typed words of last 1-80 trials of the main experiment
df2 <- valid %>% 
          select('subject', starts_with("AV")) %>% 
                  pivot_longer(
                    cols = -subject,
                     names_to = c("trial"), 
                    values_to = "word") %>%
                    group_by(subject) %>%
                    mutate(trial = seq(81,160, by = 1))
# bind first 80 and last 80 trials together
df_words <- bind_rows(df1, df2) %>%
        arrange(subject, trial)
# delete word columns from wide data frame
valid_red <- valid_red %>% 
  select(!starts_with(c("AW", "AV")))


### FAMILIARIZATION WORDS 
### (only to control that ppt payed attention to the task)
# typed words of first 1-80 trials of the familiarization
df1 <- valid %>% 
          select('subject', starts_with("FA03")) %>% 
                  pivot_longer(
                    cols = -subject,
                     names_to = c("trial"), 
                    values_to = "fam_typed") %>%
                    group_by(subject) %>%
                    mutate(trial = seq(1,80, by = 1)) 
# typed words of last 1-80 trials of the main experiment
df2 <- valid %>% 
          select('subject', starts_with("FA04")) %>% 
                  pivot_longer(
                    cols = -subject,
                     names_to = c("trial"), 
                    values_to = "fam_typed") %>%
                    group_by(subject) %>%
                    mutate(trial = seq(81,160, by = 1))
# bind first 80 and last 80 trials together
df_fam <- bind_rows(df1, df2) %>%
        arrange(subject, trial)
# delete word columns from wide data frame
valid_red <- valid_red %>% 
  select(!starts_with(c("FA03", "FA04")))

### Bind the four trial-wise dataframes together
df_main <- merge(df_fam, df_words, by = c("subject", "trial"))
df_main <- merge(df_main, df_letters, by= c("subject", "trial") )
df_main <- merge(df_main, df_timing, by= c("subject", "trial") ) %>%
  arrange(subject, trial)
```

Adapt wide dataframe with only info that is assessed only once
```{r}
# delete columns that contain only NAs
valid_red <- valid_red %>% select_if(~sum(!is.na(.)) > 0)

# for pretest only (less than 10 data points): calculate time sum by
# hand: sum dwell times for each page
valid_red <- valid_red %>% 
  mutate_at(vars(contains("TIME0")), as.numeric)
valid_red <- valid_red %>% rowwise() %>% 
  mutate(timetotal = rowSums(across(starts_with("TIME0")))/60)

# delete columns with info we don't need
valid_red <- valid_red %>% 
  select(-c(CASE, QUESTNNR, MODE, STARTED, SD22_PRV,
                        SD22_BID, SD22_ScW, SD22_ScH, SD22_QnW, 
                        SD28_01, SD29_01, KB02_01, KB03_01, KB03_02,
                        KB03_03, FA02_01, PT01, PT02, PT03, PT04, 
                        TIME002, TIME003, TIME005, TIME007, TIME008,
                        TIME010, TIME011, TIME012, TIME014, TIME015, 
                        TIME016, TIME018, TIME019, TIME021, TIME022, 
                        TIME023, TIME024, TIME025, TIME026, TIME027, 
                        TIME028, TIME029, TIME030, LASTDATA, 
                        Q_VIEWER, LASTPAGE, MAXPAGE, MISSING, MISSREL, 
                        DEG_TIME))

# give columns more recognizable names
valid_red <- valid_red %>% 
  rename(array_no = OR01_01, gender = SD01, age = SD02_01,
                     language.test = SD20, language = SD21, 
                     os_system = SD22_OS, browser = SD22_BNM,
                     system_format  = SD22_FmF, prolificid = SD24_01,
                     fingers_l = SD25, fingers_r = SD26, 
                     handedness = SD27 , keyboard_type = KB01, 
                     comments = IM01_01, time_wo_outlier = TIME_SUM )

```

Bind long and wide data frame
```{r}
# Repeat each subjects'row 160 times (no of trials)
valid_red <- valid_red %>% slice(rep(seq_len(n()), 160))

# bind wide and long info together
df <- bind_cols(valid_red, df_main) 
df <- df %>% select(-subject...111) %>% 
  rename(subject = subject...109) %>% 
  relocate(subject)
```

Convert numeric variables from string to integer:
```{r}
#str(df)
df <-  df %>% 
  mutate_at(vars(!c("prolificid","word", "comments", 
                    "AY01_01", contains("TT0"), contains("fam_typed"),
                    contains("letters"))), as.numeric)
```


Add array for each participant
```{r}
# load arrays
arrays <- read.csv(here::here("data", "arrays.csv"), 
    sep = ";", na = "NA")
# delete empty lines
arrays %>% filter()

# bind arrays to data frame
array_experiment <- bind_rows(arrays[,unique(df$array_no)])
array_experiment <- as.data.frame(unlist(lapply( array_experiment[ , 
                        names(array_experiment)], as.character) ))
df$item <- array_experiment[,1]

# add category columns
df <- df %>% group_by(item) %>% 
  mutate(category = arrays$categorie[arrays$item == item]) %>%
  mutate(supercategory = arrays$supercategorie[arrays$item == item] )

# add position number
df <- df %>% group_by(subject, category) %>% 
  add_count() %>% 
  mutate(PosOr = seq(1:n)) %>% select(-n)
```
Export prepared data frame
```{r}
write.csv(df,here::here("data", "pretest_long"), row.names = FALSE)
```


# Check attention checks

# Sample description

# Exclude wront answers
