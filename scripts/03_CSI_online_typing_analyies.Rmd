---
title: "03_CSI_online_typing_analysis"
author: "Kirsten Stark"
date: "2/28/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load packages
```{r}
library(dplyr)
library(tidyr)
library(lme4)
library(lmerTest)
library(Rmisc)
library(Cairo)
#library(strengejacke)
library(ggplot2)

options(scipen=999)

rm(list = ls())
```


## Load and preprocess data

```{r}
options( "encoding" = "UTF-8" )
df <- read.csv(here::here("data", "pretest_long.csv"))
#pretest <- read_delim(here::here("data", "pretest_complete.csv"), 
#    ";", escape_double = FALSE, na = "", 
#    trim_ws = TRUE)
```

Check amount of participants and trials and exclude fillers
```{r}
# no. of participants: 
length(unique(df$subject))

# no. of trials is 160 per participant? 
nrow(df) == 160 * length(unique(df$subject))

# exclude rows with filler trials
#df <- df %>% filter(category != "Filler")
#nrow(df)/length(unique(df$subject)) # 120 Trials per participant
```

## Check participants answer behavior
```{r}
answers <- data.frame(df$subject, df$item, df$word) %>%
  dplyr:: rename(item = df.item, word = df.word) %>%
  mutate(item =  toupper(item)) %>% 
  mutate(word = toupper(word))
sum(is.na(answers$word))

# when item and word are exactly identical, the answer is correct
answers <- answers %>% filter(item != word)

# if entry was submitted by enter key, delete 'Enter'
answers <- answers %>% mutate(word = case_when(
    endsWith(word, "ENTER") ~ stringr::str_sub(word, end = -6),
    !endsWith(word, "ENTER") ~ word))
answers <- answers %>% filter(item != word)

# if entry was submitted by space bar, delete 'space'
answers <- answers %>% mutate(word = case_when(
    endsWith(word, " ") ~ stringr::str_sub(word, end = -2),
    !endsWith(word, " ") ~ word))
answers <- answers %>% filter(item != word)

# answers that we still consider as correct: 
# 1) synonymes
# 2) typos or corrections that should not affect first letter timing
answers.sort <- with(answers,  answers[order(item) , ])
answers <- answers %>%  filter(word != "ARMAND", # Item = Armband
                               word != "ARZTKIZEBACKSPACEBACKSPACETTEL", # Item = Arztkittel
                               word != "AUTP", # Item = Auto
                               word != "ACCBACKSPACEBACKSPACEXT", # Item = Axt
                               word != "BABANBACKSPACEBACKSPACEBACKSPACENANE", # Item = Banane
                               word != "BANANAEBACKSPACEBACKSPACEE", # Item = Banane
                               word != "BAKBACKSPACENK", # Item = Bank
                               word != "BANLBACKSPACEK+", # Item = Bank
                               word != "BÖRBACKSPACEBACKSPACEÄR", # Item = Bär
                               word != "BOHRER", # Item = Bohrmaschine
                               word != "BONOBON", # Item = Bonbon
                               word != "BRKBACKSPACEOKKOLI", # Item = Brokkoli
                               word != "BROCHBACKSPACEBACKSPACESCHE", # Item = Brosche, 
                               word != "BURH", # Item = BURG
                               word != "SOFA", # Item = COUCH
                               word != "SOBACKSPACEBACKSPACEBACKSPACECOBACKSPACEBACKSPACEBACKSPACECOUCH", # Item = Couch
                               word != "DAUENBACKSPACENENWESTE", # Item = DAUNENWESTE
                               word != "WESTE", # Item = DAUNENWESTE
                               word != "WEBACKSPACEBACKSPACESHIFTDAUNENWESTE", # Item = DAUNENWESTE
                               word != "FEIEBACKSPACELE", # Item = FEILE
                               word != "FUSSBACKSPACES", # Item = Fuss
                               word != "GEABEBACKSPACEBACKSPACEBACKSPACEBACKSPACEABEL", # Item = Gabel
                               word != "SPÜLMASCHINE", # Item = GESCHIRRSPÜLER	
                               word != "GESCHRIBACKSPACEBACKSPACEIRRSPÜLER", # Item = Geschirrspüler
                               word != "GOLDFISH", # Item =Goldfisch
                               word != "GLBACKSPACEOLDSBACKSPACEFISCH", # Item = Goldfisch)
                               word != "FISCH", # Item = Goldfisch
                               word != "GONEBACKSPACEDLE", # Item =GONDEL
                               word != "HOCHHAUSEBACKSPACE", # Item =HOCHHAUS
                               word != "HPCKER", # Item =HOCKER
                               word != "KAFFEMASCHINE", # Item =KAFFEEMASCHINE
                               word != "KAFFEMBACKSPACEEMASCHINE", # Item = KAFFEEMASCHINE	
                               word != "TEEKANNE",# Item = KANNE
                               word != "KAPUZEPULLI",# Item = KAPUZENPULLI	
                               word != "KATBACKSPACEROTTE",# Item = KAROTTE
                               word != "KAROTEBACKSPACETE",# Item = KAROTTE
                               word != "KARTOFFELL",# Item = KARTOFFEL
                               word != "SUPPENKELLE",# Item = KELLE
                               word != "BÜRLOKLAMEMR",# Item = KLAMMER
                               word != "BÜROKLAMMER",# Item = KLAMMER
                               word != "SCHRANK",# Item = KLEIDERSCHRANK	
                               word != "TOPRTE",# Item = KUCHEN
                               word != "KUTZSBACKSPACEBACKSPACESCHE",# Item = KUTSCHE
                               word != "LINRBACKSPACEEAL",# Item = LINEAL
                               word != "LÖGFFEL",# Item = LÖFFEL
                               word != "LÖSEBACKSPACEBACKSPACEWE",# Item = LÖWE
                               word != "MIRKOWELLE",# Item = MIKROWELLE
                               word != "MIKBACKSPACERBACKSPACEKROWELLE",# Item = MIKROWELLE	
                               word != "MIGBACKSPACERBACKSPACEKROWELLE",# Item = MIKROWELLE 
                               word != "MPOTORRAD",# Item = MOTORRAD
                               word != "PAPRIKE",# Item = PAPRIKA
                               word != "PARPIKA", # Item = PAPRIKA
                               word != "MANTEL",# Item = PELZMANTEL
                               word != "PERBACKSPACELZMANTEL",# Item = PELZMANTEL	
                               word != "RADIERHUMMEBACKSPACEI",# Item = RADIERGUMMI	
                               word != "REABACKSPACEGAL",# Item = REGAL
                              word !=  "ROCHENENTERENTERENTERENTERENTERENTERENTERENTERENTERENTERENTER",# Item = ROCHEN
                               word != "SAEBACKSPACEFE",# Item = SAFE
                               word != "SAKKO7BACKSPACE",# Item = SAKKO
                               word != "KISTE",# Item = SCHACHTEL
                              word !=  "SPATEN",# Item = SCHAUFEL
                              word != "SCHOLOLADE",# Item =  SCHOKOLADE
                             word !=  "SCHOKOLOBACKSPACEASDBACKSPACEBACKSPACEDE", # Item = SCHOKOLADE
                              word != "SCHRAUVENZIEHER", # Item = SCHRAUBENZIEHER
                              word != "SEGELSSCBACKSPACEBACKSPACECHIFF", # Item = SEGELSCHIFF	
                              word != "SCHIFF", # Item = SEGELSCHIFF	
                              word != "SEGELBOOT", # Item = SEGELSCHIFF	
                              word != "SESSEÖ", # Item = SESSEL
                              word != "SONNENBLIME", # Item = SONNENBLUME	
                              word != "KAFFEETASSE", # Item = TASSE
                              word != "TAIBACKSPACEUBE", # Item = TAUBE
                              word != "TEPEL", # Item = TEMPEL
                              word != "TRAUBE", # Item = TRAUBEN
                              word != "TRAUEBNBACKSPACEBACKSPACEBACKSPACEBEN", # Item = TRAUBEN 
                              word != "TUPBACKSPACELPE", # Item = TULPE
                              word != "USHIFTBOOT", # Item = U-BOOT
                              word != "U-SHIFTBOOT", # Item = U-BOOT
                              word != "BOOT", # Item = YACHT
                             #Filler 
                              word != "WANNE", # Item =  BADEWANNE
                              word != "BEBACKSPACEADEWANNE", # Item =  BADEWANNE
                              word != "BRIEFKSBACKSPACEASTEN", # Item =  BRIEFKASTEN	
                             word !=  "BREIFBACKSPACEBACKSPACEBACKSPACEIEFKASTEN", # Item =  BRIEFKASTEN	
                             word !=  "BRIEFMARE", # Item =  BRIEFMARKE	
                             word !=  "BRILLLBACKSPACEE", # Item =  BRILLE
                              word != "BIBACKSPACERILLE", # Item =  BRILLE
                              word != "FECBACKSPACEBACKSPACEÄCHER", # Item =  FÄCHER
                              word != "FEBACKSPACEÄCHER", # Item =  FÄCHER
                              word != "FENSTER+BACKSPACE", # Item =  FENSTER
                              word != "FOTOAPPARAT", # Item =  KAMERA
                              word != "KASSEEBACKSPACETTE", # Item =  KASSETTE
                              word != "KASETTE", # Item =  KASSETTE
                              word != "KOPFHÖRRBACKSPACEER", # Item =  KOPFHÖRER
                              word != "KISSEN", # Item =  KOPFKISSEN
                              word != "BALLON", # Item =  LUFTBALLON	
                             word !=  "MIKROPHON", # Item =  MIKROFON
                              word != "PARGUM", # Item =  PARFUM
                              word != "PFEIGE", # Item =  PFEIFE
                             word !=  "SCHORNSETBACKSPACEBACKSPACEBACKSPACESTEIN", # Item =  SCHORNSTEIN	
                              word != "SCJBACKSPACEHORNTEIN", # Item =  SCHORNSTEIN
                             word !=  "DOLCH", # Item =  SCHWERT
                             word != "DOCLH", # Item =  SCHWERT
                             word !=  "STREICHHOLFBACKSPACEZ", # Item =  STREICHHOLZ	
                              word != "ZIGARTEBACKSPACEBACKSPACEETTE", # Item =  ZIGARETTE
                             word !=  "ZIGARTEBACKSPACEBACKSPACEABACKSPACEETTEENTER", # Item =  ZIGARETTE
)

# These 49 entries will be considered as incorrect 
(answers)

# Set incorrect entries to NA in data frame
sum(is.na(df$word))
for(i in 1:nrow(df)) {
  if(is.na(df$word[i])){
    df$correct[i] <- NA
  } else {
    df$correct[i] <- 1
  }}

for (i in 1:nrow(answers)) {
  df$correct[df$subject == answers$df.subject[i] & 
            df$item == tolower(answers$item[i])] <- NA
}

# adapt ordinal position for fillers: by mini-block (5 fillers per mini-block)
table(df$PosOr)
count <- 1
for (i in 1:nrow(df)) {
  if(df$category [i] == "Filler") {
    df$PosOr[i] <- count
    count <- count+1
  }
  if(count == 6) {  count <- 1}
}
table(df$PosOr)

# # set ordinal position to NA for unvalid trials
# for(i in 1:nrow(df_red)) {
#   if(is.na(df_red$word[i])) {
#     df_red$PosOr[i] <- NA
#   }}
# #sum(is.na(df_red$PosOr))

# factorize colums
is.numeric(df$timing.01)
df$PosOr <- as.factor(df$PosOr)
df$subject <- as.factor(df$subject)

# pretest only: save data frame with incorrect trials set to NA 
write.csv(df, here::here("data", "pretest_long_correct.csv"))

```

# ALL TRIALS
### Plot RTs by OrPos

```{r}
is.numeric(df$timing.01)
df$PosOr <- as.factor(df$PosOr)
df$subject <- as.factor(df$subject)
# descriptives 
(means <- Rmisc::summarySEwithin(df[df$category != "Filler" ,],"timing.01",idvar = "subject",withinvars = "PosOr", na.rm = T))
```


Make plots suitable for APA format, font sizes can be adjusted
```{r}
apatheme <- theme_bw()+
  theme(plot.title=element_text(family="Arial",size=22,hjust = .5),
        panel.grid.major=element_blank(), panel.grid.minor=element_blank(),
        panel.border=element_blank(),axis.line=element_line(),
        text=element_text(family="Arial",size=16))
```


```{r}
(plot <- ggplot(data=df[df$category != "Filler" ,], aes(x=PosOr, y=timing.01)) +
  stat_summary(fun=mean,  geom="point", size = 2)+
  stat_summary(fun=mean,  geom="line", size = 1) +
  apatheme+
  labs(x="Ordinal Position ",y ="RT ms")+
  annotate(geom="text", x=2, y=1200, label="n = 4", color="black", size = 8))


# ggsave(plot = plot, file = "figures/RT_across_conditions.pdf", device = cairo_pdf, dpi = 300)
# embedFonts(file = "figures/RT_across_conditions_CSI_online_typing.pdf")
```
  
Plot by subcategory
```{r}

(plot_by_cat <- ggplot(data=df[df$category != "Filler" ,], aes(x=PosOr, y=timing.01)) +
  stat_summary(fun=mean,  geom="point", size = 2)+
  stat_summary(fun=mean,  geom="line", size = 1) +
  facet_wrap(~category) +
  apatheme+
  labs(x="Ordinal Position ",y ="RT ms"))
#ggsave(plot = plot30_facet, file = "Plots/CSI_subcats.pdf", device = cairo_pdf,dpi = 300)
#embedFonts(file = "Plots/CSI_online30_subcats.pdf")

```

Plot by subject: 
```{r}

(plot_by_cat <- ggplot(data=df[df$category != "Filler" ,], aes(x=PosOr, y=timing.01)) +
  stat_summary(fun=mean,  geom="point", size = 2)+
  stat_summary(fun=mean,  geom="line", size = 1) +
  facet_wrap(~subject) +
  apatheme+
  labs(x="Ordinal Position ",y ="RT ms"))
#ggsave(plot = plot30_facet, file = "Plots/CSI_subcats.pdf", device = cairo_pdf,dpi = 300)
#embedFonts(file = "Plots/CSI_online30_subcats.pdf")

```

# Correct trials only
```{r}
# descriptives 
(means_unvalidtoNA <- Rmisc::summarySEwithin(df[df$category != "Filler"  & df$correct == 1,],"timing.01",idvar = "subject",withinvars = "PosOr", na.rm = T))
```



### Plot RTs by OrPos

```{r}
(plot <- ggplot(data=df[df$category != "Filler"  & df$correct == 1,], aes(x=PosOr, y=timing.01)) +
  stat_summary(fun=mean,  geom="point", size = 2)+
  stat_summary(fun=mean,  geom="line", size = 1) +
  apatheme+
  labs(x="Ordinal Position ",y ="RT ms")+
  annotate(geom="text", x=2, y=1200, label="n = 4", color="black", size = 8))


# ggsave(plot = plot, file = "figures/RT_across_conditions.pdf", device = cairo_pdf, dpi = 300)
# embedFonts(file = "figures/RT_across_conditions_CSI_online_typing.pdf")
```
  
Plot by subcategory
```{r}

(plot_by_cat <- ggplot(data=df[df$category != "Filler"  & df$correct == 1,], aes(x=PosOr, y=timing.01)) +
  stat_summary(fun=mean,  geom="point", size = 2)+
  stat_summary(fun=mean,  geom="line", size = 1) +
  facet_wrap(~category) +
  apatheme+
  labs(x="Ordinal Position ",y ="RT ms"))
#ggsave(plot = plot30_facet, file = "Plots/CSI_subcats.pdf", device = cairo_pdf,dpi = 300)
#embedFonts(file = "Plots/CSI_online30_subcats.pdf")

```

Plot by subject: 
```{r}

(plot_by_cat <- ggplot(data=df[df$category != "Filler"  & df$correct == 1,], aes(x=PosOr, y=timing.01)) +
  stat_summary(fun=mean,  geom="point", size = 2)+
  stat_summary(fun=mean,  geom="line", size = 1) +
  facet_wrap(~subject) +
  apatheme+
  labs(x="Ordinal Position ",y ="RT ms"))
#ggsave(plot = plot30_facet, file = "Plots/CSI_subcats.pdf", device = cairo_pdf,dpi = 300)
#embedFonts(file = "Plots/CSI_online30_subcats.pdf")

```

### Control: Plot Rts of Fillers
```{r}
(plot <- ggplot(data=df[df$category == "Filler"  & df$correct == 1,], aes(x=PosOr, y=timing.01)) +
  stat_summary(fun=mean,  geom="point", size = 2)+
  stat_summary(fun=mean,  geom="line", size = 1) +
  apatheme+
  labs(x="Ordinal Position ",y ="RT ms")+
  annotate(geom="text", x=2, y=1200, label="n = 4", color="black", size = 8))
```

### Control: Plot RTs accross the experiment
```{r}
(plot <- ggplot(data=df[df$correct == 1,], aes(x=trial, y=timing.01)) +
  stat_summary(fun=mean,  geom="point", size = 2)+
  stat_summary(fun=mean,  geom="line", size = 1) +
  apatheme+
  labs(x="Trial ",y ="RT ms")+
  annotate(geom="text", x=2, y=1200, label="n = 4", color="black", size = 8))
```

# lmms 

```{r}
hist(df$timing.01)

# Full GLMM with polynomial contrasts
contrasts(df$PosOr) <- contr.poly(5)
# m1 <- glmer(timing.01 ~ PosOr + (PosOr|subject) +(PosOr|category) ,
#              data = df[df$category != "Filler"  & df$correct == 1,], family =Gamma(link ="identity"), control=glmerControl(optimizer = "bobyqa"))
#model does not converge
m1 <- afex::lmer_alt(timing.01 ~ PosOr + (PosOr||subject) +(PosOr||category) , 
             data = df[df$category != "Filler"  & df$correct == 1,], family =Gamma(link ="identity"), control=glmerControl(optimizer = "bobyqa"))
summary(m1)

# linear trend only
fixef_terms <- model.matrix( ~ PosOr,df) 
df$PosOr.L <- fixef_terms[,2]
m2 <- afex::lmer_alt(timing.01 ~ PosOr.L + (PosOr.L||subject) +(1|category) , 
             data = df[df$category != "Filler"  & df$correct == 1,], family =Gamma(link ="identity"), control=glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2*10^5)))
summary(m2)

# Ordinal position as continuous predictor variable
df$PosOr.cont <- scale(as.numeric(as.character(df$PosOr)), center = T, scale = F)
m3 <- glmer(timing.01 ~ PosOr.cont + (PosOr.cont|subject) +(PosOr.cont|category) ,
             data = df[df$category != "Filler"  & df$correct == 1,], family =Gamma(link ="identity"), control=glmerControl(optimizer = "bobyqa"))
summary(m3)
```
