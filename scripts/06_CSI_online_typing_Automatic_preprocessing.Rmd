---
title: "06 CSI online typing: Automatic preprocessing"
author: "Kirsten Stark"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load packages

```{r load_packages}
rm(list = ls())

library(tidyr)
library(dplyr)
library(stringr)
library(stringdist)

options( "encoding" = "UTF-8" )
```

## Load data

```{r load_data}
# input 
input = "data_long_final.csv"

# input synonym/alternative naming list
alternatives = "naming_alternatives.csv"

# load data
df <- read.csv(here::here("data", input))

# load alternatives
alternatives <- read.csv(here::here("data", alternatives), sep = ";")
```


## Answer classification
Delete space and enter of the end of each typed word

```{r}
df <- df %>% mutate(wordc = case_when(
  str_ends(word, " ") ~ str_sub(word, end=str_length(word)-1),
  str_ends(word, "Enter") ~ str_sub(word, end =str_length(word)-5),
  TRUE ~ word))
```

Add additional column with words without backspaces

```{r function_replace_backspace}
replace_backspace <- function(word) {
  x <- word
  nletters = str_count("Backspace") 
  backspaces <- str_locate_all(x, "Backspace")[[1]]
  for(i in 1:nrow(backspaces)){
      x <- sub(str_c(".{1}","Backspace"), "", x)
    }
  return(x)
}
```

Apply function:

```{r}
for(i in 1:nrow(df)) {
  df$wordcorrected[i] <- replace_backspace(df$wordc[i])
}
```

Classify:

```{r classification_function}
case_character_type <- function(word, item, wordcorrected, jw, bestmatch) {
  case_when(
    # correct answers: participants typed exactly the correct word, 
    # with space or enter at the end
     toupper(word) == toupper(item) | 
       toupper(word) == toupper(str_c(item, " ")) |
       toupper(word) == toupper(str_c(item, "Enter")) ~ "correct",
       
    # backspace_space_enter: participants started by typing backspace, space,
    # enter, or capslock
     str_starts(word,"Backspace") |
       str_starts(word," ") |
       str_starts(word,"CapsLock") |
       str_starts(word,"Enter") ~ "backspace_space_enter",
    
    # shift_start: participants started by pressing the shift key
     str_starts(word,"Shift") ~ "shift_start",
    
    # isna: participants didn't enter anything
      is.na(word)       ~ "isna",
    
    # correctedtocorrect: participants corrected their entry to the correct
    # word using "Backspace"
    (toupper(wordcorrected) == toupper(item) | 
       toupper(wordcorrected) == toupper(str_c(item, " ")) |
       toupper(wordcorrected) == toupper(str_c(item, "Enter"))) &
        substring(wordcorrected,1,1) == substring(word,1,1) &
        substring(word,2, 10) != "Backspace" ~ "correctedtocorrect",
    
    # almostcorrect: jw limits needs to be set!
    jw < .30 & substring(wordcorrected,1,1) == substring(bestmatch,1,1) ~ "almostcorrect",
    
    # are all answers classified
    TRUE                      ~ "not_classified" )
}
```


```{r}
df <- df %>% mutate(answer_auto = case_character_type(
  word, item, wordcorrected, jw, bestmatch))#%>% 
 # pull(answer_auto)
df$correct_auto <- ifelse(df$answer_auto == "correct" | 
                            df$answer_auto == "almostcorrect" | 
      df$answer_auto == "correctedtocorrect", 1, NA)
sum(is.na(df$answer_auto))
table(df$answer_auto)
table(df$answercode)
table(df$correct)
table(df$correct_auto)
sum(df$answer_auto == "correct" | df$answer_auto == "almostcorrect" | 
      df$answer_auto == "correctedtocorrect")
sum(df$answercode == "correct" | df$answercode == "almostcorrect")

df2 <- df %>% filter(correct == 1 & is.na(correct_auto) )
table(df2$wordcorrected, df2$item)
df3 <- df %>% filter(correct_auto == 1 & is.na(correct) )
table(df2$wordcorrected, df2$item)
```


Fuzzy string matching:
1) Replace special characters by coded numbers

```{r}
df$wordcorrected <- df$wordcorrected %>% 
  str_replace_all(., pattern = "Enter", replacement = "1") %>% 
  str_replace_all(., pattern = "CapsLock", replacement = "2") %>% 
  str_replace_all(., pattern = "Shift", replacement = "3") %>% 
  str_replace_all(., pattern = "ArrowLeft", replacement = "4") %>% 
  str_replace_all(., pattern = "ArrowRight", replacement = "5") %>% 
  str_replace_all(., pattern = "Backspace", replacement = "6")  
```


2) Calculate stringdistance

```{r}
df$jw <- stringdist(df$wordcorrected, df$item, method = "jw")
df$bestmatch <- df$item

for(i in 1:nrow(df)){
  #i = 765
 # print(i)
  if(toupper(df$item[i]) %in% toupper(alternatives$item)) {
    word <- toupper(df$wordcorrected[i])
    item <- toupper(df$item[i])
    for (j in 1:ncol(alternatives %>% 
                     dplyr:: select(starts_with("alternative")))) {
      currentalternative <- toupper(alternatives[
          toupper(alternatives$item) == item, j+2])
      if(currentalternative != "") {
        dist <- stringdist(word, currentalternative , method = "jw")}
        if(dist < df$jw[i] & !is.na(df$jw[i])) {
          df$jw[i] <- dist
          df$bestmatch[i] <- currentalternative
        }
    }
  }
}
df$wordcorrected[df$jw < .30 & df$bestmatch != df$item]

```




1) Perfectly correct answers: Participants typed the expected word, with an Enter or a space in the end. These answers are consideres as correct

```{r correct}
df$answer_auto = NA
df <- df %>% mutate(answer_auto = case_when(toupper(word) == toupper(item) ~ "correct",
                                      toupper(word) == toupper(str_c(item, " ")) ~ "correct",
                                     toupper(word) == toupper(str_c(item, "Enter")) ~
                                        "correct"))
table(df$answer_auto)
sum(df$answercode == "correct")
table(df$answercode)
#str_c(..., sep = "", collapse = NULL)
table(df$word[df$answer_auto != "correct" & df$answercode == "correct"], df$item[df$answer_auto != "correct" & df$answercode == "correct"])
df$word[df$answer_auto != "correct" & df$answercode == "correct"]
df$item[df$answer_auto != "correct" & df$answercode == "correct"]
table(df$answer_auto == "correct" & df$answercode == "correct")
table(df$answer_auto, df$answercode)
df %>% filter(answercode == "correct") %>% filter(answer_auto != "correct") %>% nrow()
```

Trials where participants didn't give any answer:

```{r isna}
df <- df %>% mutate(answer_auto = case_when(is.na(word) ~ "isna",
                                            TRUE ~ answer_auto))
table(df$answer_auto)
```

Trials where participants started by typing backspace, capslock, space, or enter (considered as incorrect):

```{r backspace_space_enter}
df <- df %>% mutate(answer_auto = case_when(str_starts(word,"Backspace") ~ "backspace_space_enter",
                                            str_starts(word," ") ~ "backspace_space_enter", 
                                            str_starts(word,"CapsLock") ~ "backspace_space_enter",
                                            str_starts(word,"Enter") ~ "backspace_space_enter",
                                            TRUE ~ answer_auto))
table(df$word[df$answer_auto != "backspace_space_enter" & df$answercode == "backspace_space_enter"])
df$word[df$answercode == "backspace_space_enter"]
```

Trials where participants started by pressing the shift key:

```{r shift}
df <- df %>% mutate(answer_auto = case_when(str_starts(word,"Shift") ~ "shift_start",
                                            TRUE ~ answer_auto))
```

Trials where participants typed accepted alternative namings, proceeding to the next page by pressing or enter: 

```{r alternative_namings}
df <- df %>% mutate(answer_auto = case_when(
  toupper(word) == toupper(item) & toupper(word) == answer_auto ~
                                              "correct",
                                     TRUE ~ answer_auto))
```


```{r classification_function}

case_character_type <- function(word, item) {
  case_when(
    # correct answers: participants typed exactly the correct word, 
    # with space or enter at the end
     toupper(word) == toupper(item) | 
       toupper(word) == toupper(str_c(item, " ")) |
       toupper(word) == toupper(str_c(item, "Enter")) ~ "correct",
       
    # backspace_space_enter: participants started by typing backspace, space,
    # enter, or capslock
     str_starts(word,"Backspace") |
       str_starts(word," ") |
       str_starts(word,"CapsLock") |
       str_starts(word,"Enter") ~ "backspace_space_enter",
    
    # shift_start: participants started by pressing the shift key
     str_starts(word,"Shift") ~ "shift_start",
    
    # isna: participants didn't enter anything
      is.na(word)       ~ "isna",
    
    # are all answers classified
    TRUE                      ~ "not_classified" )
}
```

```{r classify}
df <- df %>% mutate(answer_auto = case_character_type(word,item))#%>% 
 # pull(answer_auto)
table(df$answer_auto)
table(df$answercode)
```

```{r}
# df %>% mutate(newword = str_locate(word, "Backspace"))
# df$word
# backspace <- str_locate_all("BAÖLBackspaceBackspaceLLEnter", "Backspace")[[1]]
# for (i in 1:nrow(backspace)){
#   replace <- stringi::stri_sub("BAÖLBackspaceBackspaceLLEnter", from = backspace[i,1] +j, length = nletters+1, "")
#  #replace <- str_replace("BAÖLBackspaceBackspaceLLEnter", replace, "")
#   j = i*nletters
# }
# while(!is.na(str_locate("BAÖLBackspaceBackspaceLLEnter", "Backspace")[1])) {
#   backspace = str_locate("BAÖLBackspaceBackspaceLLEnter", "Backspace")[1]
#   replace <- stringi::stri_sub("BAÖLBackspaceBackspaceLLEnter", from = backspace-1, length = nletters+1, "")
#  #replace <- str_replace("BAÖLBackspaceBackspaceLLEnter", replace, "")
# }
# 
# backspace <- str_locate_all("MABackspaceBackspacePELZABackspaceMANTELEnter", "Backspace")[[1]]
# word = "MABackspaceBackspacePELZABackspaceMANTELEnter"
# nletters = str_count("Backspace") 
# for(i in 1:nrow(backspace)) {
#   backspace_curr = str_locate(word, "Backspace")[1]
#   replace <- stringi::stri_sub(word, from = backspace_curr - 1, 
#                                length = nletters +1, "")
#   word <- str_replace(word, replace, "")
#   print(word)
#   #replace <- stringi::stri_sub(replace, from = 5-1, length = nletters+1, "")
#   #word <- str_replace(word, replace, "")
#   #i = i+1
# }
# 
# 
# 
# nrow(backspace)
# nletters = str_count("Backspace") 
# start = backspace[1,1] - nrow(backspace)
# replace <- stringi::stri_sub("BAÖLBackspaceBackspaceLLEnter", from = backspace[1,1] - nrow(backspace), length = nletters * nrow(backspace) + nrow(backspace), "")
# str_replace("BAÖLBackspaceBackspaceLLEnter", replace, "")
# 
# 
# gsub("\\w ","---","BAÖLBackspaceBackspaceLLEnter")
# gsub(".*\\.","", data$column 
# str_sub("BAÖLBackspaceBackspaceLLEnter", str_locate("BAÖLBackspaceBackspaceLLEnter", "Backspace")[,1]-1) 
```

```{r function_replace_backspace}
replace_backspace <- function(word) {
  #word = "HARANBackspaceBackspaceBackspaceBackspaceBackspaceKUSCHEEnter"
  x <- word
  nletters = str_count("Backspace") 
  backspaces <- str_locate_all(x, "Backspace")[[1]]
  for(i in 1:nrow(backspaces)){
      x <- sub(str_c(".{1}","Backspace"), "", x)
      #print(x)
    }
  #if(str_starts(word,"Backspace") & !is.na(word)) {
  #  return(NA)} else if (x != word & !is.na(word)) {return(x)} else {return(NA)}
  return(x)
}

```

```{r}
replace_backspace <- function(word) {
  #word <- df$word[27]
  for( i in 1:length(word)) {
    x <- word[i]
   # x <- df$word[27]
    nletters = str_count("Backspace") 
    backspaces <- str_locate_all(word[i], "Backspace")[[1]]
    for(i in 1:nrow(backspaces)){
      word[i] <- sub(str_c(".{1}","Backspace"), "", word[i])
    }
    #word[i] <- x
  }
  return(word)
}
```


hhghj

```{r}
df$wordcorrect <- replace_backspace(df$word)


#words <- c("AAL", "balläsBackspaceBackspacexx", "foBackspaceuss")
df$wordscorrected <- NA
for(i in 1:nrow(df)) {
  #print(i)
  df$wordscorrected[i] <- replace_backspace(df$word[i])
}
sum(is.na(df$wordscorrected))
df$wordscorrected[df$word == "FU?BackspaceSBackspace=Backspace?Backspace "]
df$word[is.na(df$wordscorrected)]

df <- df %>% mutate(wordscorrect = replace_backspace(word))
table(df$wordscorrected)
df$wordcorrected <- replace_backspace(df$word)
df$wordscorrect == df$wordscorrected
```





```{r df_corrected_words}
#df$wordcorrected <- NA
#for(i in 1:nrow(df)){
#  df$wordcorrected[i] <- replace_backspace(df$word[i])
#}
#df$wordcorrected[996] <- replace_backspace(df$word[996])
df <- df %>% mutate(wordcorrected = replace_backspace(word))
table(df$wordcorrected)
sum(is.na(df$wordcorrected))
sum(df$word == df$wordcorrected, na.rm = T)
df$wordcorrected
```


```{r}
sum(!is.na(replace_backspace(df$word)))
df %>% mutate(word_corrected = replace_backspace(word)) %>% pull(word_corrected)

df$word_corrected

 nrow(str_locate_all("AAL", "Backspace")[[1]])
nrow(str_locate_all("AALBackspace", "Backspace")[[1]]) != 0
```
